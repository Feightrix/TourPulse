<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TourPulse — Admin Console</title>
  <link rel="icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico">

  <!-- Sitewide CSS -->
  <link rel="stylesheet" href="css/style.css">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body.tp-admin .adminBanner{
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.76);
      border-radius: 22px;
      padding: 18px 18px;
      box-shadow: 0 18px 50px rgba(2,6,23,.10);
      position:relative;
      overflow:hidden;
      margin-top: 12px;
    }
    body.tp-admin .adminBanner:before{
      content:"";
      position:absolute; inset:-40% -30%;
      background: radial-gradient(circle at 20% 20%, rgba(10,166,181,.14), transparent 52%),
                  radial-gradient(circle at 85% 40%, rgba(15,23,42,.06), transparent 55%);
      pointer-events:none;
    }
    body.tp-admin .adminBannerInner{ position:relative; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    body.tp-admin .adminBannerTitle{ display:flex; flex-direction:column; gap:2px; }
    body.tp-admin .adminBannerTitle .k{
      font-size:12px; font-weight:1100; letter-spacing:.22px; text-transform:uppercase;
      color: rgba(15,23,42,.62); margin:0;
    }
    body.tp-admin .adminBannerTitle .h{
      font-size:26px; font-weight:1300; letter-spacing:.2px;
      color: rgba(15,23,42,.92); margin:0; line-height:1.05;
    }
    body.tp-admin .adminPill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 14px; border-radius: 999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.78);
      box-shadow: 0 12px 30px rgba(2,6,23,.08);
      font-weight:1100; color: rgba(15,23,42,.82);
      white-space:nowrap;
    }
    body.tp-admin .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(10,166,181,.95);
      box-shadow: 0 0 0 6px rgba(10,166,181,.14);
      display:inline-block;
    }

    body.tp-admin .adminGrid{
      display:grid;
      grid-template-columns: 1.15fr .95fr;
      gap:16px;
      margin-top: 16px;
    }
    @media (max-width: 980px){
      body.tp-admin .adminGrid{ grid-template-columns: 1fr; }
    }

    body.tp-admin .card h2{
      margin:0;
      font-size:22px;
      font-weight:1300;
      color: rgba(15,23,42,.92);
      letter-spacing:.1px;
    }
    body.tp-admin .subline{
      margin:8px 0 0;
      color: rgba(15,23,42,.62);
      font-weight:850;
    }

    body.tp-admin .accountsTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top: 12px;
    }
    body.tp-admin .searchRow{ flex: 1 1 auto; display:flex; align-items:center; gap:10px; min-width: 240px; }
    body.tp-admin .searchRow .search{ flex: 1 1 auto; }

    body.tp-admin .btnSoft{
      display:inline-flex; align-items:center; justify-content:center;
      border-radius: 14px;
      padding: 12px 14px;
      border:1px solid rgba(10,166,181,.22);
      background: linear-gradient(180deg, rgba(10,166,181,.96), rgba(7,131,143,.96));
      color: rgba(255,255,255,.96);
      font-weight:1200;
      letter-spacing:.1px;
      box-shadow: 0 18px 40px rgba(2,6,23,.10);
      cursor:pointer;
      min-width: 118px;
    }
    body.tp-admin .btnSoft:active{ transform: translateY(1px); }

    body.tp-admin .listBox{
      margin-top: 12px;
      border-radius: 18px;
      border:1px dashed rgba(15,23,42,.20);
      background: rgba(255,255,255,.55);
      padding: 10px;
      min-height: 210px;
    }

    body.tp-admin .userRow{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.75);
      box-shadow: 0 10px 26px rgba(2,6,23,.06);
      margin-bottom: 10px;
      cursor:pointer;
      user-select:none;
    }
    body.tp-admin .userRow:hover{
      outline: 3px solid rgba(10,166,181,.18);
      outline-offset: 2px;
    }
    body.tp-admin .userMeta{ display:flex; flex-direction:column; gap:3px; }
    body.tp-admin .userName{ font-weight:1300; color: rgba(15,23,42,.92); letter-spacing:.1px; line-height:1.05; }
    body.tp-admin .userSub{
      font-weight:900; color: rgba(15,23,42,.62);
      font-size: 12px; letter-spacing:.18px; text-transform:uppercase;
    }
    body.tp-admin .pillTiny{
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.8);
      font-weight:1100;
      color: rgba(15,23,42,.78);
      white-space:nowrap;
    }

    body.tp-admin .empty{
      border:1px dashed rgba(15,23,42,.22);
      border-radius: 16px;
      padding: 16px 14px;
      background: rgba(255,255,255,.55);
      font-weight:1200;
      color: rgba(15,23,42,.62);
      margin: 8px 0 0;
    }

    /* small note (replaces big warning) */
    body.tp-admin .note{
      margin-top: 10px;
      font-size: 12px;
      font-weight: 950;
      color: rgba(15,23,42,.58);
      display:none;
    }
    body.tp-admin .note.show{ display:block; }

    body.tp-admin .miniGrid{ display:grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    body.tp-admin .mini{
      border-radius: 18px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.75);
      box-shadow: 0 14px 34px rgba(2,6,23,.08);
      padding: 14px 14px;
    }
    body.tp-admin .mini .label{
      font-size:12px; font-weight:1100; letter-spacing:.22px; text-transform:uppercase;
      color: rgba(15,23,42,.62);
    }
    body.tp-admin .mini .value{
      margin-top: 6px; font-size: 30px; font-weight: 1400; letter-spacing:.2px;
      color: rgba(15,23,42,.92); line-height:1.05;
    }
    body.tp-admin .mini .hint{ margin-top: 10px; font-size: 13px; font-weight: 950; color: rgba(15,23,42,.62); }

    body.tp-admin .snapOverlay{
      position: fixed; inset: 0; background: rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      padding: 18px; z-index: 1200;
    }
    body.tp-admin .snapOverlay.show{ display:flex; }
    body.tp-admin .snapModal{
      width: min(980px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.92);
      box-shadow: 0 30px 90px rgba(2,6,23,.35);
      overflow:hidden;
    }
    body.tp-admin .snapHeader{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 16px 16px;
      border-bottom: 1px solid rgba(15,23,42,.10);
      background: linear-gradient(180deg, rgba(10,166,181,.10), rgba(255,255,255,.0));
    }
    body.tp-admin .snapHeader h3{
      margin:0; font-size:20px; font-weight:1400;
      color: rgba(15,23,42,.92); letter-spacing:.1px; line-height:1.1;
    }
    body.tp-admin .snapHeader .small{
      margin-top: 6px; color: rgba(15,23,42,.62);
      font-weight: 950; font-size: 13px;
    }
    body.tp-admin .snapBody{
      padding: 14px 16px 16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 920px){
      body.tp-admin .snapBody{ grid-template-columns: 1fr; }
    }
    body.tp-admin .snapCard{
      border-radius: 18px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.78);
      box-shadow: 0 14px 34px rgba(2,6,23,.08);
      padding: 14px 14px;
      overflow:hidden;
    }
    body.tp-admin .snapCard .t{
      font-size:12px; font-weight:1100; letter-spacing:.22px; text-transform:uppercase;
      color: rgba(15,23,42,.62); margin:0;
    }
    body.tp-admin .snapCard .big{
      margin-top: 8px; font-size: 18px; font-weight: 1300;
      color: rgba(15,23,42,.92); letter-spacing:.1px;
    }
    body.tp-admin .kv{
      margin-top: 10px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px 12px;
      align-items:center;
      font-weight:1100;
    }
    body.tp-admin .kv .k{ color: rgba(15,23,42,.62); }
    body.tp-admin .kv .v{ color: rgba(15,23,42,.92); font-weight:1400; }
    body.tp-admin pre.mono{
      margin: 10px 0 0;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(2,6,23,.04);
      max-height: 260px;
      overflow:auto;
      font-size: 12px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
    }
    body.tp-admin .xBtn{
      border:0;
      background: rgba(255,255,255,.0);
      width: 40px; height: 40px;
      border-radius: 12px;
      font-size: 26px;
      line-height: 40px;
      cursor:pointer;
      color: rgba(15,23,42,.72);
    }
    body.tp-admin .xBtn:hover{
      background: rgba(15,23,42,.06);
      color: rgba(15,23,42,.92);
    }
  </style>
</head>

<body class="tp-admin">
  <div class="wrap choose-calc">
    <section class="panel" aria-label="Admin Console">
      <div class="topbar">
        <div class="brand">
          <div class="logoBox" aria-hidden="true">
            <img src="images/MTK-logo.png" alt="TourPulse Logo" />
          </div>
          <div class="brandText">
            <p class="title">TourPulse</p>
            <p class="sub" id="welcomeLine">Powered by F8</p>
          </div>
        </div>

        <div class="rightStack">
          <div class="userPill" title="Signed-in account">
            <div class="name" id="userName">—</div>
            <div class="emp" id="userEmp">—</div>
          </div>
          <button class="btnGhost" type="button" id="btnBack">← Back</button>
          <button class="btnGhost" type="button" id="btnSignOut">Sign Out</button>
        </div>
      </div>

      <div class="adminBanner">
        <div class="adminBannerInner">
          <div class="adminBannerTitle">
            <p class="k">Admin Console</p>
            <p class="h">Usage &amp; Stats</p>
          </div>
          <div class="adminPill" aria-label="Read-only indicator">
            <span class="dot" aria-hidden="true"></span>
            <span>Read-only</span>
          </div>
        </div>
      </div>

      <div class="adminGrid">
        <div class="card">
          <h2>Accounts</h2>
          <p class="subline">Select a user to open a snapshot modal (template for now).</p>

          <div class="accountsTop">
            <div class="searchRow">
              <div class="search" role="search" aria-label="Search users">
                <span class="searchIcon" aria-hidden="true"></span>
                <input id="searchUsers" type="text" placeholder="Search users…" autocomplete="off" />
              </div>
            </div>
            <button class="btnSoft" type="button" id="btnRefresh">Refresh</button>
          </div>

          <div class="listBox" id="usersList" aria-label="Users list">
            <div class="empty">Loading…</div>
          </div>

          <div class="note" id="sourceNote"></div>
        </div>

        <div class="card">
          <h2>Overview</h2>
          <p class="subline">Template overview block (we’ll populate later).</p>

          <div class="miniGrid">
            <div class="mini">
              <div class="label">Total Users</div>
              <div class="value mono" id="kpiTotalUsers">0</div>
              <div class="hint">From Supabase list</div>
            </div>

            <div class="mini">
              <div class="label">Most Recent Activity</div>
              <div class="value mono" id="kpiLastSeen">—</div>
              <div class="hint">Placeholder</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="snapOverlay" id="snapOverlay" role="dialog" aria-modal="true" aria-labelledby="snapTitle">
    <div class="snapModal">
      <div class="snapHeader">
        <div>
          <h3 id="snapTitle">Account Snapshot</h3>
          <div class="small" id="snapSub">—</div>
        </div>
        <button class="xBtn" type="button" id="snapClose" aria-label="Close">×</button>
      </div>

      <div class="snapBody">
        <div class="snapCard">
          <p class="t">At-a-glance</p>
          <div class="big" id="snapName">—</div>

          <div class="kv">
            <div class="k">Emp</div><div class="v mono" id="snapEmp">—</div>
            <div class="k">Email</div><div class="v mono" id="snapEmail">—</div>
            <div class="k">Last Seen</div><div class="v mono" id="snapLastSeen">—</div>
          </div>
        </div>

        <div class="snapCard">
          <p class="t">Snapshot (template)</p>
          <div class="big">Current Stats</div>

          <div class="kv">
            <div class="k">Trip Points</div><div class="v mono" id="snapTripPoints">—</div>
            <div class="k">Pay Calc</div><div class="v mono" id="snapPayCalc">—</div>
            <div class="k">Site Calc</div><div class="v mono" id="snapSiteCalc">—</div>
          </div>

          <pre class="mono" id="snapJson">{}</pre>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const SUPABASE_URL = "https://mqiofvksgipmowyfjqjn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xaW9mdmtzZ2lwbW93eWZqcWpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTI1NTcsImV4cCI6MjA4MzY2ODU1N30.SRXzBegzmjvXcJHxIwH8sBSlWO6A2tsTC274wR-Ioe8";

    const SIGNIN_PAGE = "signin.html";
    const BACK_PAGE = "choose-calc.html";

    const ADMIN_EMP = "078195";

    const USERS_SOURCE_TABLE = "tp_admin_users";
    const SNAPSHOT_RPC = "tp_admin_snapshot_user";
    const SNAPSHOT_TABLE = "tp_admin_user_snapshot";
    const CALC_STATE_TABLE = "tp_calc_state";

    const sb = (window.supabase && window.supabase.createClient)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const $ = (id) => document.getElementById(id);

    function showToast(msg, ms = 2200){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      window.clearTimeout(showToast._timer);
      showToast._timer = window.setTimeout(() => t.classList.remove("show"), ms);
    }
    function goSignin(){ window.location.replace(SIGNIN_PAGE); }
    function goBack(){ window.location.href = BACK_PAGE; }
    function getEmpFromEmail(email){ return String(email || "").split("@")[0] || ""; }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function formatTime(ts){
      if(!ts) return "—";
      const d = new Date(ts);
      if(Number.isNaN(d.getTime())) return "—";
      return d.toLocaleString(undefined, { month:"short", day:"numeric", year:"numeric", hour:"numeric", minute:"2-digit" });
    }

    async function requireAuthOrRedirect(){
      if(!sb) return goSignin();

      const { data: { session } } = await sb.auth.getSession();
      if(!session?.user) return goSignin();

      const user = session.user;
      const first = user.user_metadata?.first_name || "";
      const emp = getEmpFromEmail(user.email);

      $("userName").textContent = first || "Signed In";
      $("userEmp").textContent = emp ? `#${emp}` : "";

      if(String(emp) !== String(ADMIN_EMP)){
        showToast("Admin access denied.");
        return goBack();
      }

      return { user, emp, first };
    }

    async function signOut(){
      if(!sb) return goSignin();
      const { error } = await sb.auth.signOut();
      if(error){ showToast(error.message || "Sign out failed."); return; }
      showToast("Signed out.");
      goSignin();
    }

    $("btnBack").addEventListener("click", goBack);
    $("btnSignOut").addEventListener("click", () => signOut());

    if(sb){
      sb.auth.onAuthStateChange((event, session) => {
        if(event === "SIGNED_OUT" || !session?.user) goSignin();
      });
    }

    let ALL_USERS = [];

    function renderUsers(list){
      const box = $("usersList");
      box.innerHTML = "";

      if(!list.length){
        box.innerHTML = `<div class="empty">No users found.</div>`;
        $("kpiTotalUsers").textContent = "0";
        $("kpiLastSeen").textContent = "—";
        return;
      }

      $("kpiTotalUsers").textContent = String(list.length);

      list.forEach(u => {
        const row = document.createElement("div");
        row.className = "userRow";
        row.setAttribute("data-userid", u.user_id || "");
        row.setAttribute("role", "button");
        row.setAttribute("tabindex", "0");

        const name = u.first_name || u.name || "User";
        const emp = u.emp ? `#${u.emp}` : "—";
        const email = u.email || "—";
        const last = u.last_seen_at ? formatTime(u.last_seen_at) : "—";

        row.innerHTML = `
          <div class="userMeta">
            <div class="userName">${escapeHtml(name)}</div>
            <div class="userSub">${escapeHtml(emp)} • ${escapeHtml(email)} • ${escapeHtml(last)}</div>
          </div>
          <div class="pillTiny">View</div>
        `;

        row.addEventListener("click", () => openSnapshot(u));
        row.addEventListener("keydown", (e) => {
          if(e.key === "Enter" || e.key === " "){
            e.preventDefault();
            openSnapshot(u);
          }
        });

        box.appendChild(row);
      });

      const newest = list
        .filter(x => x.last_seen_at)
        .sort((a,b) => new Date(b.last_seen_at) - new Date(a.last_seen_at))[0];

      $("kpiLastSeen").textContent = newest?.last_seen_at ? formatTime(newest.last_seen_at) : "—";
    }

    function applyUserSearch(){
      const q = String($("searchUsers").value || "").trim().toLowerCase();
      if(!q) return renderUsers(ALL_USERS);

      const filtered = ALL_USERS.filter(u => {
        const s = [u.first_name, u.name, u.emp, u.email, u.user_id]
          .map(x => String(x || "").toLowerCase()).join(" ");
        return s.includes(q);
      });

      renderUsers(filtered);
    }

    function setSourceNote(text){
      const el = $("sourceNote");
      if(!text){
        el.textContent = "";
        el.classList.remove("show");
        return;
      }
      el.textContent = text;
      el.classList.add("show");
    }

    async function fetchUsers(){
      setSourceNote("");
      $("usersList").innerHTML = `<div class="empty">Loading…</div>`;

      // Preferred: tp_admin_users view/table (we’ll wire later)
      const primary = await sb
        .from(USERS_SOURCE_TABLE)
        .select("user_id,emp,first_name,email,last_seen_at")
        .order("last_seen_at", { ascending: false, nullsFirst: false });

      if(!primary.error && Array.isArray(primary.data)){
        ALL_USERS = primary.data.map(x => ({
          user_id: x.user_id,
          emp: x.emp,
          first_name: x.first_name,
          email: x.email,
          last_seen_at: x.last_seen_at
        }));
        setSourceNote(""); // no note when the “real” source works
        renderUsers(ALL_USERS);
        return;
      }

      // Fallback: infer users from tp_calc_state (still Supabase)
      const fallback = await sb
        .from(CALC_STATE_TABLE)
        .select("user_id,updated_at")
        .order("updated_at", { ascending: false })
        .limit(500);

      if(!fallback.error && Array.isArray(fallback.data)){
        const seen = new Map();
        (fallback.data || []).forEach(r => {
          const uid = String(r.user_id || "");
          if(!uid) return;
          if(!seen.has(uid)){
            seen.set(uid, {
              user_id: uid,
              emp: "",
              first_name: "",
              email: "",
              last_seen_at: r.updated_at
            });
          }
        });

        ALL_USERS = Array.from(seen.values());
        setSourceNote("Using fallback source (tp_calc_state). Names/emails will appear after we wire tp_admin_users.");
        renderUsers(ALL_USERS);
        return;
      }

      // Nothing works yet
      ALL_USERS = [];
      setSourceNote("No admin user source is available yet. We’ll wire tp_admin_users next.");
      renderUsers([]);
    }

    $("searchUsers").addEventListener("input", applyUserSearch);
    $("btnRefresh").addEventListener("click", () => fetchUsers());

    // Snapshot modal (template)
    function openModal(){ $("snapOverlay").classList.add("show"); }
    function closeModal(){ $("snapOverlay").classList.remove("show"); }

    $("snapClose").addEventListener("click", closeModal);
    $("snapOverlay").addEventListener("click", (e) => { if(e.target === $("snapOverlay")) closeModal(); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") closeModal(); });

    async function openSnapshot(u){
      $("snapTitle").textContent = "Account Snapshot";
      $("snapSub").textContent = "Template (we’ll wire data next)";
      $("snapName").textContent = u.first_name || u.name || "User";
      $("snapEmp").textContent = u.emp ? `#${u.emp}` : "—";
      $("snapEmail").textContent = u.email || "—";
      $("snapLastSeen").textContent = u.last_seen_at ? formatTime(u.last_seen_at) : "—";

      $("snapTripPoints").textContent = "—";
      $("snapPayCalc").textContent = "—";
      $("snapSiteCalc").textContent = "—";
      $("snapJson").textContent = JSON.stringify(u, null, 2);

      openModal();
    }

    (async function init(){
      await requireAuthOrRedirect();
      await fetchUsers();
    })();
  </script>
</body>
</html>
