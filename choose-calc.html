<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TourPulse — Choose Calculator</title>
  <link rel="icon" href="favicon.ico">
  <link rel="shortcut icon" href="favicon.ico">

  <!-- Sitewide CSS -->
  <link rel="stylesheet" href="css/style.css">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <div class="wrap choose-calc">
    <section class="panel" aria-label="Choose Calculator">
      <div class="topbar">
        <div class="brand">
          <div class="logoBox" aria-hidden="true">
            <img src="images/MTK-logo.png" alt="TourPulse Logo" />
          </div>
          <div class="brandText">
            <p class="title">TourPulse</p>
            <p class="sub" id="welcomeLine">Powered by F8</p>
          </div>
        </div>

        <div class="rightStack">
          <div class="userPill" title="Signed-in account">
            <div class="name" id="userName">—</div>
            <div class="emp" id="userEmp">—</div>
          </div>
          <button class="btnGhost" type="button" id="btnSignOut">Sign Out</button>
        </div>
      </div>

      <div class="hero">
        <div class="heroLeft">
          <h1 id="heroTitle">Choose a Calculator</h1>
          <p id="heroSub">Only Marketer Pay is active right now. The rest will unlock as we build them.</p>
        </div>

        <div class="heroRight">
          <div class="search" role="search" aria-label="Search calculators">
            <span class="searchIcon" aria-hidden="true"></span>
            <input id="searchInput" type="text" placeholder="Search calculators…" autocomplete="off" />
          </div>
        </div>
      </div>

      <div class="sectionTitle">
        <h2>Calculators</h2>
        <p class="hint" id="countHint">—</p>
      </div>

      <div class="grid" id="cardsGrid"></div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * SUPABASE CONFIG (yours)
     ***********************/
    const SUPABASE_URL = "https://mqiofvksgipmowyfjqjn.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xaW9mdmtzZ2lwbW93eWZqcWpuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwOTI1NTcsImV4cCI6MjA4MzY2ODU1N30.SRXzBegzmjvXcJHxIwH8sBSlWO6A2tsTC274wR-Ioe8";
    const SIGNIN_PAGE = "signin.html";

    const sb = (window.supabase && window.supabase.createClient)
      ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    const $ = (id) => document.getElementById(id);

    function showToast(msg, ms = 2200){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      window.clearTimeout(showToast._timer);
      showToast._timer = window.setTimeout(() => t.classList.remove("show"), ms);
    }

    function goSignin(){ window.location.replace(SIGNIN_PAGE); }

    function getEmpFromEmail(email){
      return String(email || "").split("@")[0] || "";
    }

    /***********************
     * ADMIN GATE (wired to your existing RPC)
     * We infer admin status by attempting tp_admin_list_users:
     * - success => admin
     * - failure => not admin (fallback to emp allowlist)
     ***********************/
    const RPC_LIST_USERS = "tp_admin_list_users";
    const ADMIN_EMPS_FALLBACK = ["078195"];

    function isAdminEmpFallback(emp){
      const e = String(emp || "").trim();
      return !!e && ADMIN_EMPS_FALLBACK.includes(e);
    }

    async function tryRpcListUsers(payload){
      const { data, error } = await sb.rpc(RPC_LIST_USERS, payload);
      if(error) return { ok:false, error };
      return { ok:true, data };
    }

    async function checkIsAdmin(emp){
      // no supabase? fallback
      if(!sb) return isAdminEmpFallback(emp);

      // Try a few payload shapes safely (covers different function signatures)
      const attempts = [
        {}, // if function takes no params
        { p_search: null, p_limit: 1, p_offset: 0 },
        { p_search: "",   p_limit: 1, p_offset: 0 },
        { search: null,   limit: 1,   offset: 0 },
        { search: "",     limit: 1,   offset: 0 }
      ];

      for(const payload of attempts){
        try{
          const res = await tryRpcListUsers(payload);
          if(res.ok){
            // If we can list users at all, this account is admin.
            return true;
          }
          // If we got a “not found” or signature mismatch, keep trying other payloads
          const code = res.error?.code || "";
          if(code === "PGRST202" || code === "404") continue;

          // Permission denied / RLS / other failures => treat as not admin
          console.warn("admin rpc error:", res.error);
          return isAdminEmpFallback(emp);
        }catch(err){
          console.warn("admin rpc exception:", err);
          return isAdminEmpFallback(emp);
        }
      }

      // None of the payload shapes matched the RPC signature
      return isAdminEmpFallback(emp);
    }

    /***********************
     * MENU
     ***********************/
    const CALCS = [
      {
        key: "marketer-pay",
        title: "Marketer Pay Calculator",
        desc: "Estimate comp fast based on site rules and tour outcomes.",
        path: "pay-calc.html",
        locked: false
      },
      {
        key: "site-calculator",
        title: "Site Calculator",
        desc: "Site-based math tools you’ll use all day — clean and fast.",
        path: "site-calc.html",
        locked: false
      },

      // ✅ Admin gateway (hidden unless admin)
      {
        key: "admin",
        title: "Admin Console",
        desc: "View logins, usage, and captured tour inputs across calculators.",
        path: "admin-console.html",
        locked: false,
        adminOnly: true
      },
      {
        key: "sales-volume",
        title: "Sales Volume",
        desc: "Handy helpers (conversions, pacing, daily checks).",
        path: "",
        locked: true
      }
    ];

    let _isAdmin = false;

    function getVisibleCalcs(){
      return CALCS.filter(c => !c.adminOnly || _isAdmin);
    }

    function renderCards(list){
      const grid = $("cardsGrid");
      grid.innerHTML = "";

      list.forEach(item => {
        const card = document.createElement("div");
        card.className = "calcCard";

        const locked = !!item.locked;
        const isAdminCard = !!item.adminOnly;

        const badge = locked
          ? `<span class="badge">LOCKED</span>`
          : (isAdminCard ? `<span class="badge">ADMIN</span>` : ``);

        const btnClass = locked ? "goBtn locked" : "goBtn open";
        const btnText  = locked ? "Locked" : "Open";
        const dataPath = locked ? "" : (item.path || "");

        card.innerHTML = `
          <div class="calcTop">
            <div class="calcIcon" aria-hidden="true"></div>
            <div class="badgeRow">${badge}</div>
          </div>

          <div>
            <div class="calcTitle">${item.title}</div>
            <p class="calcDesc">${item.desc}</p>
          </div>

          <button class="${btnClass}" type="button" data-path="${dataPath}">
            ${btnText}
          </button>
        `;

        grid.appendChild(card);
      });

      $("countHint").textContent = `${list.length} shown`;
    }

    function applySearch(){
      const q = String($("searchInput").value || "").trim().toLowerCase();
      const base = getVisibleCalcs();

      if(!q){
        renderCards(base);
        return;
      }

      const filtered = base.filter(c =>
        c.title.toLowerCase().includes(q) ||
        c.desc.toLowerCase().includes(q) ||
        c.key.toLowerCase().includes(q)
      );
      renderCards(filtered);
    }

    function wireCardClicks(){
      $("cardsGrid").addEventListener("click", (e) => {
        const btn = e.target?.closest?.("button[data-path]");
        if(!btn) return;

        const path = btn.getAttribute("data-path") || "";
        if(!path){
          showToast("Locked for now.");
          return;
        }
        window.location.href = path;
      });
    }

    /***********************
     * AUTH GATE + HEADER
     ***********************/
    async function requireAuthOrRedirect(){
      if(!sb) return goSignin();

      const { data: { session } } = await sb.auth.getSession();
      if(!session?.user) return goSignin();

      const user = session.user;
      const first = user.user_metadata?.first_name || "";
      const emp = getEmpFromEmail(user.email);

      _isAdmin = await checkIsAdmin(emp);

      $("userName").textContent = first || "Signed In";
      $("userEmp").textContent = emp ? `#${emp}` : "";
      $("welcomeLine").textContent = "Powered by F8";

      $("heroTitle").textContent = first ? `What are we running today, ${first}?` : "Choose a Calculator";

      if(_isAdmin){
        $("heroSub").textContent = "Admin Console is enabled for your account.";
      }
    }

    async function signOut(){
      if(!sb) return goSignin();
      const { error } = await sb.auth.signOut();
      if(error){
        showToast(error.message || "Sign out failed.");
        return;
      }
      showToast("Signed out.");
      goSignin();
    }

    $("btnSignOut").addEventListener("click", () => signOut());

    if(sb){
      sb.auth.onAuthStateChange((event, session) => {
        if(event === "SIGNED_OUT" || !session?.user) goSignin();
      });
    }

    (async function init(){
      await requireAuthOrRedirect();
      renderCards(getVisibleCalcs());
      wireCardClicks();
      $("searchInput").addEventListener("input", applySearch);
    })();
  </script>
</body>
</html>
